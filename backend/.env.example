const express = require("express");
const mysql = require("mysql2");
const cors = require("cors");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
require("dotenv").config();

const app = express();

app.use(express.json());

app.use(
  cors({
    origin: "https://healthtrack-project.vercel.app",
    methods: ["GET", "POST", "PUT", "DELETE"],
    credentials: true,
  })
);

const db = mysql.createPool({
  host: process.env.MYSQLHOST,
  user: process.env.MYSQLUSER,
  password: process.env.MYSQLPASSWORD,
  database: process.env.MYSQLDATABASE,
  port: Number(process.env.MYSQLPORT),
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
});

app.get("/", (req, res) => res.json("Backend is running ✅"));
app.get("/check", (req, res) => res.json("CHECK OK ✅"));

app.get("/users", (req, res) => {
  const sql = "SELECT * FROM users";
  db.query(sql, (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.get("/users/:id", (req, res) => {
  const id = req.params.id;
  const sql = "SELECT * FROM users WHERE id = ?";
  db.query(sql, [id], (err, data) => {
    if (err) return res.status(500).json(err);
    if (data.length === 0) return res.status(404).json({ message: "User not found" });
    return res.json(data[0]);
  });
});

app.post("/users", (req, res) => {
  const { full_name, email, password } = req.body;
  const sql = "INSERT INTO users(full_name, email, password) VALUES (?,?,?)";
  db.query(sql, [full_name, email, password], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.put("/users/:id", (req, res) => {
  const id = req.params.id;
  const { full_name, email, password } = req.body;
  const sql = "UPDATE users SET full_name= ?, email= ?, password= ? WHERE id = ?";
  db.query(sql, [full_name, email, password, id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.delete("/users/:id", (req, res) => {
  const id = req.params.id;
  const sql = "DELETE FROM users WHERE id = ?";
  db.query(sql, [id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.post("/login", (req, res) => {
  const { email, password } = req.body;
  const sql = "SELECT * FROM users WHERE email = ?";
  db.query(sql, [email], (err, data) => {
    if (err) return res.status(500).json(err);
    if (data.length === 0) return res.status(404).json({ message: "User not found" });
    const user = data[0];
    if (user.password !== password) {
      return res.status(401).json({ message: "Wrong password" });
    }
    return res.json({
      message: "Login successful",
      user: {
        id: user.id,
        full_name: user.full_name,
        email: user.email,
        is_admin: user.is_admin,
      },
    });
  });
});

app.get("/contacts", (req, res) => {
  const sql = "SELECT * FROM contacts";
  db.query(sql, (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.get("/contacts/:id", (req, res) => {
  const id = req.params.id;
  const sql = "SELECT * FROM contacts WHERE id = ?";
  db.query(sql, [id], (err, data) => {
    if (err) return res.status(500).json(err);
    if (data.length === 0) return res.status(404).json({ message: "Contact not found" });
    return res.json(data[0]);
  });
});

app.post("/contacts", (req, res) => {
  const { full_name, email, subject, message, user_id } = req.body;
  const sql = "INSERT INTO contacts(full_name, email, subject, message, user_id) VALUES (?,?,?,?,?)";
  db.query(sql, [full_name, email, subject, message, user_id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.put("/contacts/:id", (req, res) => {
  const id = req.params.id;
  const { full_name, email, subject, message, user_id } = req.body;
  const sql = "UPDATE contacts SET full_name=?, email=?, subject=?, message=?, user_id=? WHERE id=?";
  db.query(sql, [full_name, email, subject, message, user_id, id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.delete("/contacts/:id", (req, res) => {
  const id = req.params.id;
  const sql = "DELETE FROM contacts WHERE id = ?";
  db.query(sql, [id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.get("/messages", (req, res) => {
  const sql = "SELECT * FROM contacts";
  db.query(sql, (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.get("/messages/user/:user_id", (req, res) => {
  const user_id = req.params.user_id;
  const sql = "SELECT * FROM contacts WHERE user_id = ?";
  db.query(sql, [user_id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.get("/bmi_records", (req, res) => {
  const sql = "SELECT * FROM bmi_records";
  db.query(sql, (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.get("/bmi_records/:id", (req, res) => {
  const id = req.params.id;
  const sql = "SELECT * FROM bmi_records WHERE id = ?";
  db.query(sql, [id], (err, data) => {
    if (err) return res.status(500).json(err);
    if (data.length === 0) return res.status(404).json({ message: "Record not found" });
    return res.json(data[0]);
  });
});

app.post("/bmi_records", (req, res) => {
  const { weight, height, bmi_value, user_id } = req.body;
  const sql = "INSERT INTO bmi_records(weight, height, bmi_value, user_id) VALUES (?,?,?,?)";
  db.query(sql, [weight, height, bmi_value, user_id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.put("/bmi_records/:id", (req, res) => {
  const id = req.params.id;
  const { weight, height, bmi_value, user_id } = req.body;
  const sql = "UPDATE bmi_records SET weight=?, height=?, bmi_value=?, user_id=? WHERE id=?";
  db.query(sql, [weight, height, bmi_value, user_id, id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

app.delete("/bmi_records/:id", (req, res) => {
  const id = req.params.id;
  const sql = "DELETE FROM bmi_records WHERE id = ?";
  db.query(sql, [id], (err, data) => {
    if (err) return res.status(500).json(err);
    return res.json(data);
  });
});

module.exports = app;
